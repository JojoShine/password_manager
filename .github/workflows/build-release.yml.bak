name: æ„å»ºæ¡Œé¢åº”ç”¨

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'
          
      - name: å¯ç”¨Windowsæ¡Œé¢æ”¯æŒ
        run: flutter config --enable-windows-desktop
        
      - name: è·å–ä¾èµ–
        run: flutter pub get
        
      - name: æ„å»ºWindowsåº”ç”¨
        run: flutter build windows --release
        
      - name: åˆ›å»ºWindowså®‰è£…åŒ…
        run: |
          mkdir windows-release
          xcopy "build\windows\x64\runner\Release\*" "windows-release\" /E /I /Y
          
      - name: æ‰“åŒ…ä¸ºZIP
        run: |
          cd windows-release
          tar -czf ../PasswordManager-Windows.zip *
          
      - name: ä¸Šä¼ Windowsæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: PasswordManager-Windows.zip

  build-macos:
    name: æ„å»ºmacOSç‰ˆæœ¬
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'
          
      - name: å¯ç”¨macOSæ¡Œé¢æ”¯æŒ
        run: flutter config --enable-macos-desktop
        
      - name: è·å–ä¾èµ–
        run: flutter pub get
        
      - name: æ„å»ºmacOSåº”ç”¨
        run: |
          echo "=== å¼€å§‹æ„å»º macOS åº”ç”¨ ==="
          flutter build macos --release --verbose
          echo "=== æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡º ==="
          echo "æ„å»ºè¾“å‡ºç›®å½•ç»“æ„:"
          ls -la build/macos/ 2>/dev/null || echo "build/macos ç›®å½•ä¸å­˜åœ¨"
        
      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          echo "=== æ£€æŸ¥æ„å»ºäº§ç‰© ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "=== å®Œæ•´çš„ build ç›®å½•ç»“æ„ ==="
          find build -type d 2>/dev/null | head -20 || echo "build ç›®å½•ä¸å­˜åœ¨"
          
          echo "=== æŸ¥æ‰¾æ‰€æœ‰ .app æ–‡ä»¶ ==="
          find build -name "*.app" -type d 2>/dev/null || echo "æœªæ‰¾åˆ° .app ç›®å½•"
          
          echo "=== æ£€æŸ¥æ ‡å‡† Release ç›®å½• ==="
          if [ -d "build/macos/Build/Products/Release/" ]; then
            echo "Release ç›®å½•å­˜åœ¨ï¼Œå†…å®¹å¦‚ä¸‹:"
            ls -la "build/macos/Build/Products/Release/"
          else
            echo "æ ‡å‡† Release ç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "=== æ£€æŸ¥å…¶ä»–å¯èƒ½çš„æ„å»ºè¾“å‡ºä½ç½® ==="
          find build -name "*password_manager*" -o -name "*Runner*" 2>/dev/null || echo "æœªæ‰¾åˆ°ç›¸å…³æ–‡ä»¶"
          
          echo "=== æ£€æŸ¥æ˜¯å¦æœ‰å¯æ‰§è¡Œæ–‡ä»¶ ==="
          find build -type f -executable 2>/dev/null | head -10 || echo "æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        
      - name: åˆ›å»ºDMGå®‰è£…åŒ…
        run: |
          echo "=== åˆ›å»º DMG å®‰è£…åŒ… ==="
          
          # é¦–å…ˆæ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„è·¯å¾„
          echo "æ£€æŸ¥å¯èƒ½çš„ .app æ–‡ä»¶è·¯å¾„ï¼š"
          echo "1. æ ‡å‡†è·¯å¾„: build/macos/Build/Products/Release/"
          ls -la "build/macos/Build/Products/Release/" 2>/dev/null || echo "è·¯å¾„1ä¸å­˜åœ¨"
          
          echo "2. æŸ¥æ‰¾æ‰€æœ‰ .app æ–‡ä»¶:"
          find build -name "*.app" -type d 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½• .app æ–‡ä»¶"
          
          # å°è¯•å¤šä¸ªå¯èƒ½çš„è·¯å¾„
          POSSIBLE_PATHS=(
            "build/macos/Build/Products/Release/password_manager.app"
            "build/macos/Build/Products/Release/Runner.app"
            "build/macos/Build/Products/Release/*.app"
          )
          
          APP_PATH=""
          
          # å…ˆå°è¯•é¢„å®šä¹‰è·¯å¾„
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -d "$path" ] 2>/dev/null; then
              APP_PATH="$path"
              echo "æ‰¾åˆ°é¢„å®šä¹‰è·¯å¾„çš„ app æ–‡ä»¶: $APP_PATH"
              break
            fi
          done
          
          # å¦‚æœé¢„å®šä¹‰è·¯å¾„éƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨ find æŸ¥æ‰¾
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find build -name "*.app" -type d | head -1)
          fi
          
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            echo "æœ€ç»ˆæ‰¾åˆ° app æ–‡ä»¶: $APP_PATH"
            APP_NAME=$(basename "$APP_PATH" .app)
            echo "åº”ç”¨åç§°: $APP_NAME"
            
            # éªŒè¯ .app ç»“æ„
            echo "éªŒè¯ .app æ–‡ä»¶ç»“æ„:"
            ls -la "$APP_PATH/" 2>/dev/null || echo "æ— æ³•åˆ—å‡º .app å†…å®¹"
            
            # åˆ›å»º DMG
            echo "åˆ›å»º DMG æ–‡ä»¶..."
            hdiutil create -volname "å¯†ç ç®¡ç†å™¨" -srcfolder "$APP_PATH" -ov -format UDZO "å¯†ç ç®¡ç†å™¨-macOS.dmg"
            
            # éªŒè¯ DMG æ–‡ä»¶
            if [ -f "å¯†ç ç®¡ç†å™¨-macOS.dmg" ]; then
              echo "DMG æ–‡ä»¶åˆ›å»ºæˆåŠŸ!"
              ls -la "å¯†ç ç®¡ç†å™¨-macOS.dmg"
              # é‡å‘½åä¸ºè‹±æ–‡åä»¥é¿å…ä¸Šä¼ é—®é¢˜
              mv "å¯†ç ç®¡ç†å™¨-macOS.dmg" "PasswordManager-macOS.dmg"
            else
              echo "DMG æ–‡ä»¶åˆ›å»ºå¤±è´¥!"
              exit 1
            fi
          else
            echo "é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½• .app æ–‡ä»¶"
            echo "è¯¦ç»†çš„ build ç›®å½•ç»“æ„:"
            find build -type f -name "*" | head -30
            echo "æ‰€æœ‰ç›®å½•ç»“æ„:"
            find build -type d | head -20
            exit 1
          fi
          
      - name: ä¸Šä¼ macOSæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: PasswordManager-macOS.dmg

  create-release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½Windowsæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: ./artifacts
          
      - name: ä¸‹è½½macOSæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: ./artifacts
          
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/PasswordManager-Windows.zip
            ./artifacts/PasswordManager-macOS.dmg
          body: |
            ## ğŸ“¦ å¯†ç ç®¡ç†å™¨ ${{ github.ref_name }}
            
            ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
            - âœ… å¯†ç ç®¡ç†å’Œç”Ÿæˆ
            - âœ… æ•°æ®åŠ å¯†å¯¼å…¥å¯¼å‡º
            - âœ… æ·±è‰²æ¨¡å¼æ”¯æŒ
            - âœ… è‡ªå®šä¹‰å­—æ®µæ”¯æŒ
            - âœ… åˆ†ç±»ç®¡ç†
            
            ### ğŸ’¾ ä¸‹è½½è¯´æ˜
            - **Windowsç”¨æˆ·**: ä¸‹è½½ `PasswordManager-Windows.zip`ï¼Œè§£å‹åè¿è¡Œ `password_manager.exe`
            - **macOSç”¨æˆ·**: ä¸‹è½½ `PasswordManager-macOS.dmg`ï¼ŒåŒå‡»å®‰è£…
            
            ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (x64)
            - macOS 10.14+ (Intel/Apple Silicon)
            
            ---
            â­ å¦‚æœè§‰å¾—å¥½ç”¨ï¼Œè¯·ç»™é¡¹ç›®ç‚¹ä¸ªæ˜Ÿï¼
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 