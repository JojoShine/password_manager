name: æ„å»ºæ¡Œé¢åº”ç”¨

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'
          
      - name: å¯ç”¨Windowsæ¡Œé¢æ”¯æŒ
        run: flutter config --enable-windows-desktop
        
      - name: è·å–ä¾èµ–
        run: flutter pub get
        
      - name: æ„å»ºWindowsåº”ç”¨
        run: flutter build windows --release
        
      - name: åˆ›å»ºWindowså®‰è£…åŒ…
        run: |
          mkdir windows-release
          xcopy "build\windows\x64\runner\Release\*" "windows-release\" /E /I /Y
          
      - name: æ‰“åŒ…ä¸ºZIP
        run: |
          cd windows-release
          tar -czf ../PasswordManager-Windows.zip *
          
      - name: ä¸Šä¼ Windowsæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: PasswordManager-Windows.zip

  build-macos:
    name: æ„å»ºmacOSç‰ˆæœ¬
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'
          
      - name: å¯ç”¨macOSæ¡Œé¢æ”¯æŒ
        run: flutter config --enable-macos-desktop
        
      - name: è·å–ä¾èµ–
        run: flutter pub get
        
      - name: æ„å»ºmacOSåº”ç”¨
        run: flutter build macos --release
        
      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          echo "=== æ£€æŸ¥æ„å»ºäº§ç‰© ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "åˆ—å‡º build ç›®å½•ç»“æ„ï¼š"
          find build -type d -name "*.app" 2>/dev/null || echo "æœªæ‰¾åˆ° .app ç›®å½•"
          echo "åˆ—å‡º Release ç›®å½•å†…å®¹ï¼š"
          ls -la build/macos/Build/Products/Release/ 2>/dev/null || echo "Release ç›®å½•ä¸å­˜åœ¨"
          echo "åˆ—å‡ºæ‰€æœ‰ .app æ–‡ä»¶ï¼š"
          find . -name "*.app" -type d 2>/dev/null || echo "æ•´ä¸ªé¡¹ç›®ä¸­æœªæ‰¾åˆ° .app æ–‡ä»¶"
        
      - name: åˆ›å»ºDMGå®‰è£…åŒ…
        run: |
          echo "=== åˆ›å»º DMG å®‰è£…åŒ… ==="
          
          # æŸ¥æ‰¾ .app æ–‡ä»¶
          APP_PATH=$(find build -name "*.app" -type d | head -1)
          
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            echo "æ‰¾åˆ° app æ–‡ä»¶: $APP_PATH"
            APP_NAME=$(basename "$APP_PATH" .app)
            echo "åº”ç”¨åç§°: $APP_NAME"
            
            # åˆ›å»º DMG
            echo "åˆ›å»º DMG æ–‡ä»¶..."
            hdiutil create -volname "PasswordManager" -srcfolder "$APP_PATH" -ov -format UDZO "PasswordManager-macOS.dmg"
            
            # éªŒè¯ DMG æ–‡ä»¶
            if [ -f "PasswordManager-macOS.dmg" ]; then
              echo "DMG æ–‡ä»¶åˆ›å»ºæˆåŠŸ!"
              ls -la PasswordManager-macOS.dmg
            else
              echo "DMG æ–‡ä»¶åˆ›å»ºå¤±è´¥!"
              exit 1
            fi
          else
            echo "é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½• .app æ–‡ä»¶"
            echo "build ç›®å½•ç»“æ„:"
            find build -type f -name "*" | head -20
            exit 1
          fi
          
      - name: ä¸Šä¼ macOSæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: PasswordManager-macOS.dmg

  create-release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½Windowsæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: ./artifacts
          
      - name: ä¸‹è½½macOSæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: ./artifacts
          
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/PasswordManager-Windows.zip
            ./artifacts/PasswordManager-macOS.dmg
          body: |
            ## ğŸ“¦ å¯†ç ç®¡ç†å™¨ ${{ github.ref_name }}
            
            ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
            - âœ… å¯†ç ç®¡ç†å’Œç”Ÿæˆ
            - âœ… æ•°æ®åŠ å¯†å¯¼å…¥å¯¼å‡º
            - âœ… æ·±è‰²æ¨¡å¼æ”¯æŒ
            - âœ… è‡ªå®šä¹‰å­—æ®µæ”¯æŒ
            - âœ… åˆ†ç±»ç®¡ç†
            
            ### ğŸ’¾ ä¸‹è½½è¯´æ˜
            - **Windowsç”¨æˆ·**: ä¸‹è½½ `PasswordManager-Windows.zip`ï¼Œè§£å‹åè¿è¡Œ `password_manager.exe`
            - **macOSç”¨æˆ·**: ä¸‹è½½ `PasswordManager-macOS.dmg`ï¼ŒåŒå‡»å®‰è£…
            
            ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (x64)
            - macOS 10.14+ (Intel/Apple Silicon)
            
            ---
            â­ å¦‚æœè§‰å¾—å¥½ç”¨ï¼Œè¯·ç»™é¡¹ç›®ç‚¹ä¸ªæ˜Ÿï¼
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 